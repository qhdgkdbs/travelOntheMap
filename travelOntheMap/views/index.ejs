<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>여행을 가고 싶어서 만드는 중</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">
    <link rel = "stylesheet" href="/stylesheets/style.css">
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=9mlra4rwwq"></script>
    <script type="text/javascript" src="/src/MarkerClustering.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173208515-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-173208515-1');
    </script>
</head>
<body>
  <div id="navbar">랜섬<br>여행</div>
  <div id="infoBox">베타버전<br>최종수정일자<br>7.24/03:39</div>

  <div id="current"><img src="/images/nowLocation1.png" height="30px" width="30px"/><br></div>

  <div id="loading">
    <img id="loading-image" src="/images/loading.gif" alt="데이터 로딩 중입니다" />
    dataLoding...
  </div>
  <div id="map" style="width:100%;height:100vh;"></div>
  <!-- <script type="text/javascript" src="/data/data.js"></script> -->
  <script>

  var mapOptions = {
      center: new naver.maps.LatLng(37.531471, 126.979514),
      zoom: 10
  };

  var map = new naver.maps.Map('map', mapOptions);
  
  var markerList = [];
  var infowindowList = [];
  var dataList;

  // $(window).load(function() {    
  //         $('#loading').hide();  
  // });



  $.ajax({
    // url : "https://itjusttravel.herokuapp.com/file", // test.jsp 에서 받아옴
    url : "http://localhost:3000/file",
    dataType :"json", // 데이터타입을 json 으로 받아옴
    success : function(data) {
        // alert("data로딩이 완료되었습니다.")
        dataList = data;
        setContent(); 
        $('#loading').hide();  
    },
    error : function(e) {
        console.log(e.responseText);
        console.log(e);
    }
  })

  var setContent = function() {
    for(var target of dataList){
      console.log(typeof(target))
      // var target = dataList[i]
      var latlng = new naver.maps.LatLng(target.lat, target.lng) //위도 경도
      marker = new naver.maps.Marker({
        map : map,
        position : latlng,
        icon : {
          // content : "<div class='marker'></div>",
          url:'/images/icon.png',
          size: new naver.maps.Size(40, 40),
          origin: new naver.maps.Point(0, 0),
          anchor : new naver.maps.Point(16,20) // 중심 좌표를 변경해주는 것
        }
      })
      

      // var content = `<div class='infowindow_wraps'>
      //     <div class="infoImg"><img src="${target.picLink}" width=200 hdight=200></div>
      //     <div class="infowindow_text">
      //       <div class='infowindow_title'>${target.spot}</div>
      //       <div class='infowindow_content'>👉 ${target.des}</div>
      //       <div class='infowindow_more'>
      //         <a href="${target.moreLink}" title="인스타그램에서 더 확인하기" target="_blank">
      //           <div class='infowindow_more_icon'>
      //             <img src="/images/more_icon.png" width=32 hdight=32>
      //           </div>
      //         </a>
      //         </div>
      //     </div>
      //   </div>` // ${}이런식으로 변수선언이 가능함, string을 담는 값

      var content =`
        <div class="wrapper">
          <div class="card"><img src="${target.picLink}"/>
          <div style = "z-index:1000;color:white;"></div>
            <div class="info">
              <h3>${target.spot}</h3>
              <p>${target.des}</p>
              <a href="${target.moreLink}"><button>더 읽어보기</button></a>
            </div>
          </div>
        </div>  
        <div class="card2click">click🙈</div>
        `

      var infowindow = new naver.maps.InfoWindow({
        content : content,
        backgroundColor : "#00ff0000",
        borderColor : "#00ff0000",
        anchorSize : new naver.maps.Size(0,0)
      })

      markerList.push(marker);
      infowindowList.push(infowindow);
    }

    for(var i = 0,ii = markerList.length; i < ii; i++){
    naver.maps.Event.addListener(map, "click", clickMap(i));
    naver.maps.Event.addListener(markerList[i], "click", getClickHandler(i));
  }

  var htmlMarker1 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker2 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-2.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker3 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-3.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker4 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-4.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker5 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-5.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        };

    var markerClustering = new MarkerClustering({
        minClusterSize: 4,
        maxZoom: 13,
        map: map,
        markers: markerList,
        disableClickZoom: false,
        gridSize: 120,
        icons: [htmlMarker1, htmlMarker2, htmlMarker3, htmlMarker4, htmlMarker5],
        indexGenerator: function(count) {
            var index = 0;

            if (count >= 10 && count < 20) {
                index = 1;
            } else if (count >= 20 && count < 50) {
                index = 2;
            } else if (count >= 50 && count < 100) {
                index = 3;
            } else if (count >= 100) {
                index = 4;
            }

            return index;
        },
        stylingFunction: function(clusterMarker, count) {
            $(clusterMarker.getElement()).find('div:first-child').text(count);
        }
    });
  }

 
  function clickMap(i) {
    return function(){
      var infowindow = infowindowList[i]
      infowindow.close()
    }
  }

  function getClickHandler(i) {
    return function(){
      var marker = markerList[i];
      var infowindow = infowindowList[i];
      if(infowindow.getMap()){
        infowindow.close();
      }else{
        infowindow.open(map, marker)
      }
    }
  }


  maker = new naver.maps.Marker({
    map : map,
    position : new naver.maps.LatLng(37.3595704, 127.105399),
    icon : {
      content : "<div class='marker'></div>"
    }
  })

  let currentUse = true;

  $('#current').click(() => {
    if("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function(position){
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const latlng = new naver.maps.LatLng(lat, lng);
        if(currentUse){
          maker = new naver.maps.Marker({
          map : map,
          position :latlng,
          icon : {
            content : `<img class="pulse" draggable="false" unselectable="on" src="https://myfirstmap.s3.ap-northeast-2.amazonaws.com/circle.png">`,
            anchor : new naver.maps.Point(11,11)
          }
          })
          currentUse = false;
        }
        map.setZoom(14, true);
        map.panTo(latlng);

      })
    }else{
      alert("현재위치를 사용할 수 없습니다.")
    }
  })


  </script>
</body>
</html>