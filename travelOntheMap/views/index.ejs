<!-- <!DOCTYPE html> -->
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>ì—¬í–‰ì„ ê°€ê³  ì‹¶ì–´ì„œ ë§Œë“œëŠ” ì¤‘</title>
    <link rel="shortcut icon" href="https://i.postimg.cc/d061bMYv/favicon-1.png" type="image/x-icon">
    <link rel="icon" href="https://i.postimg.cc/d061bMYv/favicon-1.png" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">
    <link rel = "stylesheet" href="/stylesheets/style.css">
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=9mlra4rwwq"></script>
    <script type="text/javascript" src="/src/MarkerClustering.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-173208515-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-173208515-1');
    </script>
</head>
<body>
  <div id="navbar">ëœì„¬<br>ì—¬í–‰</div>
  <div id="infoBox">ë² íƒ€ë²„ì „</div>
  <div id="mytravel"><a href="/mylist">ë‚˜ì˜ ì—¬í–‰ì§€</a></div>
  <div id="poster"><a href="/updateinfo">ì—…ë°ì´íŠ¸ë‚´ì—­</a></div>

  <div id="current"><img src="/images/nowLocation1.png" height="30px" width="30px"/><br></div>

  <div id="loading">
    <img id="loading-image" src="/images/loading.gif" alt="ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤" />
    dataLoding...
  </div>
  <div id="map" style="width:100%;height:100vh;"></div>
  <!-- <script type="text/javascript" src="/data/data.js"></script> -->
  <script>
    var urlAdd = "http://localhost:3000/"  
    if(!window.location.href === "http://localhost:3000/"){
      urlAdd = "https://itjusttravel.herokuapp.com/"
    }

  var mapOptions = {
      center: new naver.maps.LatLng(37.531471, 126.979514),
      zoom: 10
  };

  var map = new naver.maps.Map('map', mapOptions);
  
  var markerList = [];
  var infowindowList = [];
  var dataList;

  var output = localStorage.getItem("key");		
  var myListArr = JSON.parse(output);

  var isitSavedImg = "#";

  $.ajax({
    url : urlAdd + 'file',
    dataType :"json", // ë°ì´í„°íƒ€ì…ì„ json ìœ¼ë¡œ ë°›ì•„ì˜´
    success : function(data) {
        // alert("dataë¡œë”©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        dataList = data;
        setContent(); 
        $('#loading').hide();  
    },
    error : function(e) {
        console.log(e.responseText);
        console.log(e);
    }
  })

  var setContent = function() {
    for(var target of dataList){
      // console.log(typeof(target))
      // var target = dataList[i]
      var latlng = new naver.maps.LatLng(target.lat, target.lng) //ìœ„ë„ ê²½ë„
      marker = new naver.maps.Marker({
        map : map,
        position : latlng,
        icon : {
          // content : "<div class='marker'></div>",
          url:'/images/icon.png',
          size: new naver.maps.Size(40, 40),
          origin: new naver.maps.Point(0, 0),
          anchor : new naver.maps.Point(16,20) // ì¤‘ì‹¬ ì¢Œí‘œë¥¼ ë³€ê²½í•´ì£¼ëŠ” ê²ƒ
        }
      })
      
      var isItSavedText = ""

      if(myListArr.includes(target._id)){
        // ì €ì¥ë˜ì–´ìˆë‹¤ë©´
        isItSavedText = "ì‚­ì œ";
        isitSavedImg = "images/delete.png";
      }else{
        // ì €ì¥ì•ˆë˜ì–´ ìˆìŒ
        isItSavedText = "ë‹´ê¸°";
        isitSavedImg = "images/plus.png";
      }

      var content =`
        <div class="wrapper">
          <div class="card"><img src="${target.picLink}"/>
          <div style = "z-index:1000;color:white;"></div>
            <div class="info">
              <h3>${target.spot}</h3>
              <p>${target.des}</p>
              <a href="${target.moreLink}"><button>ë” ì½ì–´ë³´ê¸°</button></a>
            </div>
          </div>
        </div>  
        <div class="card2click">clickğŸ™ˆ</div>

      
        <div class="myTravelSpot">
          <span class="isItSavedText">${isItSavedText}</span>
          <img class= "isItSavedImg" src="${isitSavedImg}" alt="heelo" width="16" height="16" onclick='saveOrDeleteRedirect("${target._id}")'>
        </div>
        `
        // <button onclick="saveSpot('${target._id}');">Save me</button>
        // changeImage("https://i.postimg.cc/d061bMYv/favicon-1.png");
        // <button onclick="console.log(JSON.parse(localStorage.getItem('key')))">Show me</button>

      var infowindow = new naver.maps.InfoWindow({
        content : content,
        backgroundColor : "#00ff0000",
        borderColor : "#00ff0000",
        anchorSize : new naver.maps.Size(0,0)
      })

      markerList.push(marker);
      infowindowList.push(infowindow);
    }

    for(var i = 0,ii = markerList.length; i < ii; i++){
    naver.maps.Event.addListener(map, "click", clickMap(i));
    naver.maps.Event.addListener(markerList[i], "click", getClickHandler(i));
  }

  var htmlMarker1 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker2 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-2.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker3 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-3.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker4 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-4.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker5 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-5.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        };

    var markerClustering = new MarkerClustering({
        minClusterSize: 4,
        maxZoom: 13,
        map: map,
        markers: markerList,
        disableClickZoom: false,
        gridSize: 120,
        icons: [htmlMarker1, htmlMarker2, htmlMarker3, htmlMarker4, htmlMarker5],
        indexGenerator: function(count) {
            var index = 0;

            if (count >= 10 && count < 20) {
                index = 1;
            } else if (count >= 20 && count < 50) {
                index = 2;
            } else if (count >= 50 && count < 100) {
                index = 3;
            } else if (count >= 100) {
                index = 4;
            }

            return index;
        },
        stylingFunction: function(clusterMarker, count) {
            $(clusterMarker.getElement()).find('div:first-child').text(count);
        }
    });
  }

  function changeImage(a) {
      document.getElementByClass("img").src=a;
  }

  function saveOrDeleteRedirect(id){
    var output = localStorage.getItem("key");		
    var myListArr = JSON.parse(output);
    if(!myListArr.includes(id)){
      //ì €ì¥ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´
      //ì €ì¥ë¡œì§
      saveSpot(id);
      $(".isItSavedImg").attr("src", "images/delete.png");
      $(".isItSavedText").text("ì‚­ì œ");
    }else{
      //ì €ì¥ëœ ê²ƒì´ë¼ë©´ 
      //ì‚­ì œë¡œì§ + ì €ì¥
      myListArr.splice(myListArr.indexOf(id),1)
      localStorage.setItem("key", JSON.stringify(myListArr));
      $(".isItSavedImg").attr("src", "images/plus.png");
      $(".isItSavedText").text("ë‹´ê¸°");
    }
    // window.location.href =urlAdd;
  }
  function clickMap(i) {
    return function(){
      var infowindow = infowindowList[i]
      infowindow.close()
    }
  }

  function saveSpot(spot_id){
    var saved = JSON.parse(localStorage.getItem('key'));
    if(!saved){saved = []}
    console.log(spot_id)
    saved.push(spot_id)

    saved = Array.from(new Set(saved));
    localStorage.setItem("key", JSON.stringify(saved));
  }

  function getClickHandler(i) {
    return function(){
      var marker = markerList[i];
      var infowindow = infowindowList[i];
      if(infowindow.getMap()){
        infowindow.close();
      }else{
        infowindow.open(map, marker)
      }
    }
  }


  maker = new naver.maps.Marker({
    map : map,
    position : new naver.maps.LatLng(37.3595704, 127.105399),
    icon : {
      content : "<div class='marker'></div>"
    }
  })

  let currentUse = true;

  $('#current').click(() => {
    if("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function(position){
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const latlng = new naver.maps.LatLng(lat, lng);
        if(currentUse){
          maker = new naver.maps.Marker({
          map : map,
          position :latlng,
          icon : {
            content : `<img class="pulse" draggable="false" unselectable="on" src="https://myfirstmap.s3.ap-northeast-2.amazonaws.com/circle.png">`,
            anchor : new naver.maps.Point(11,11)
          }
          })
          currentUse = false;
        }
        map.setZoom(14, true);
        map.panTo(latlng);

      })
    }else{
      alert("í˜„ì¬ìœ„ì¹˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    }
  })



  </script>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5f1d32cdaba5b518"></script>
  

</body>
</html>